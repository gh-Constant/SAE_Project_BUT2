generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============== USER ==============

enum Role {
  admin
  aventurier
  prestataire
}

enum AvatarType {
  gallery
  upload
}

model User {
  id_user         Int       @id @default(autoincrement())
  firstname       String    @db.VarChar(255)
  lastname        String    @db.VarChar(255)
  birth_date      DateTime?  
  bio             String?   @db.Text

  phone           String?   @db.Char(20)
  email           String    @db.VarChar(255) @unique

  role            Role
  avatar_url      String    @db.VarChar(255)
  avatar_type     AvatarType @default(gallery)
  level           Int
  xp              Float     @db.Double

  is_verified     Boolean
  password_hashed String   @db.Text

  presentation    String?  @db.LongText

  created_at      DateTime? @default(now()) @db.DateTime(0)
  updated_at      DateTime? @updatedAt @db.DateTime(0)

  id_prestataire_type Int
  
  prestataire_type PrestataireType @relation(fields: [id_prestataire_type], references: [id_prestataire_type])
  locations        Location[]
  services         Service[]
  products         Product[]

  userQuests        UserQuest[]
  commandes         Commande[]
  lignesPanier      LignePanier[]
  eventReservations EventReservation[]
  
  // QR Code relations
  qrSessionsCreated QRSession[] @relation("QRCreator")
  qrSessionsScanned QRSession[] @relation("QRScanner")

  @@map("users")
}

// ============== PRESTATAIRE ==============

model PrestataireType {
  id_prestataire_type Int      @id @default(autoincrement())
  name                String   @db.VarChar(255)
  
  created_at          DateTime? @default(now()) @db.DateTime(0)
  updated_at          DateTime? @updatedAt @db.DateTime(0)
  
  prestataires        User[]

  @@map("prestataire_types")
}

// ============== SERVICE & LOCATION ==============

model ServiceType {
  id_service_type Int    @id @default(autoincrement())
  name            String @db.VarChar(255)

  created_at DateTime? @default(now()) @db.DateTime(0)
  updated_at DateTime? @updatedAt @db.DateTime(0)

  services Service[]

  @@map("service_types")
}

model LocationType {
  id_location_type Int    @id @default(autoincrement())
  name             String @db.VarChar(255)

  created_at DateTime? @default(now()) @db.DateTime(0)
  updated_at DateTime? @updatedAt @db.DateTime(0)

  location Location[]

  @@map("location_type")
}

model Location {
  id_location Int     @id @default(autoincrement())
  name        String  @db.VarChar(255)
  description String? @db.Text
  static_code String? @db.VarChar(255)
  price       Decimal @db.Decimal(15, 2)

  purchased Boolean @default(false)

  position    Json    @db.Json
  icon_name   String? @db.VarChar(255)
  banner_name String? @db.VarChar(255)

  maximum_capacity Int

  created_at DateTime? @default(now()) @db.DateTime(0)
  updated_at DateTime? @updatedAt @db.DateTime(0)

  id_location_type Int
  id_prestataire   Int?

  location_type LocationType @relation(fields: [id_location_type], references: [id_location_type])
  prestataire   User?        @relation(fields: [id_prestataire], references: [id_user])
  services      Service[]
  events        Event[]
  quests        Quest[]
  blogs         Blog[]

  @@index([id_prestataire])
  @@map("locations")
}

model Blog {
  id_blog Int    @id @default(autoincrement())
  title   String @db.VarChar(255)
  content String @db.LongText

  created_at DateTime? @default(now()) @db.DateTime(0)
  updated_at DateTime? @updatedAt @db.DateTime(0)

  id_location Int

  location Location @relation(fields: [id_location], references: [id_location])

  @@index([id_location])
  @@map("blogs")
}

model Event {
  id_event    Int      @id @default(autoincrement())
  title       String   @db.VarChar(255)
  description String?  @db.Text
  start_time  DateTime @db.DateTime(0)
  end_time    DateTime @db.DateTime(0)

  price    Decimal @db.Decimal(15, 2)
  capacity Int
  sold     Int     @default(0)

  created_at DateTime? @default(now()) @db.DateTime(0)
  updated_at DateTime? @updatedAt @db.DateTime(0)

  id_location Int

  location     Location           @relation(fields: [id_location], references: [id_location])
  reservations EventReservation[]

  @@index([id_location])
  @@map("events")
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

model EventReservation {
  id_reservation Int               @id @default(autoincrement())
  quantity       Int
  total_price    Decimal           @db.Decimal(10, 2)
  status         ReservationStatus @default(PENDING)

  created_at DateTime @default(now()) @db.DateTime(0)
  updated_at DateTime @updatedAt @db.DateTime(0)

  id_user Int
  user    User @relation(fields: [id_user], references: [id_user])

  id_event Int
  event    Event @relation(fields: [id_event], references: [id_event])

  @@index([id_user])
  @@index([id_event])
  @@map("event_reservations")
}

model Service {
  id_service  Int     @id @default(autoincrement())
  name        String  @db.VarChar(255)
  description String? @db.Text

  created_at DateTime? @default(now()) @db.DateTime(0)
  updated_at DateTime? @updatedAt @db.DateTime(0)

  id_prestataire  Int
  id_service_type Int
  id_location     Int

  prestataire  User        @relation(fields: [id_prestataire], references: [id_user])
  service_type ServiceType @relation(fields: [id_service_type], references: [id_service_type])
  location     Location    @relation(fields: [id_location], references: [id_location])
  stock        Stock[]

  @@index([id_prestataire])
  @@index([id_service_type])
  @@index([id_location])
  @@map("services")
}

// ============== QUEST ==============

enum UserQuestStatus {
  accepted
  completed 
  failed
}

model UserQuest {
  id_user    Int
  id_quest   Int
  status     UserQuestStatus @default(accepted)

  created_at DateTime?       @default(now()) @db.DateTime(0)
  updated_at DateTime?       @updatedAt @db.DateTime(0)

  user  User  @relation(fields: [id_user], references: [id_user])
  quest Quest @relation(fields: [id_quest], references: [id_quest])

  @@id([id_user, id_quest])
  @@index([id_quest])
  @@map("userQuests")
}

model Quest {
  id_quest    Int       @id @default(autoincrement())
  title       String?   @db.VarChar(255)
  description String?   @db.Text
  xp_reward   Int?

  created_at  DateTime? @default(now()) @db.DateTime(0)
  updated_at  DateTime? @updatedAt @db.DateTime(0)
  
  id_location Int

  location   Location    @relation(fields: [id_location], references: [id_location])
  userQuests UserQuest[]

  @@index([id_location])
  @@map("quests")
}

// ============== SHOP ==============

enum EtatCommande {
    waiting
    payed
    collected
}

model Product {
  id_product     Int       @id @default(autoincrement())
  name           String    @db.VarChar(255)
  description    String?   @db.Text
  price          Decimal   @db.Decimal(15, 2)
  image          String?   @db.VarChar(255)

  modified_at    DateTime? @updatedAt @db.DateTime(0)
  created_at     DateTime? @default(now()) @db.DateTime(0)

  id_prestataire Int

  prestataire     User     @relation(fields: [id_prestataire], references: [id_user])
  lignesPanier    LignePanier[]
  stock           Stock[]
  lignesCommande LigneCommande[]

  @@index([id_prestataire])
  @@map("products")
}

model Commande {
  id_commande      Int       @id @default(autoincrement())
  date_commande    DateTime  @db.DateTime(0)
  date_collect     DateTime? @db.DateTime(0)
  total_price      Decimal   @db.Decimal(15, 2)

  created_at DateTime? @default(now()) @db.DateTime(0)
  updated_at DateTime? @updatedAt @db.DateTime(0)

  id_user          Int
  etat_commande    EtatCommande @default(waiting)

  user           User          @relation(fields: [id_user], references: [id_user])
  lignesCommande LigneCommande[]

  @@index([id_user])
  @@map("commande")
}

model LignePanier {
  id_product Int
  id_user    Int
  quantite   Int 
  price      Decimal  @db.Decimal(15, 2)

  created_at DateTime? @default(now()) @db.DateTime(0)
  updated_at DateTime? @updatedAt @db.DateTime(0)

  product Product @relation(fields: [id_product], references: [id_product])
  user    User    @relation(fields: [id_user], references: [id_user])

  @@id([id_product, id_user])
  @@index([id_user])
  @@map("ligne_panier")
}

model Stock {
  id_product Int
  id_service Int
  stock      Int
  
  created_at DateTime? @default(now()) @db.DateTime(0)
  updated_at DateTime? @updatedAt @db.DateTime(0)

  product Product @relation(fields: [id_product], references: [id_product])
  service  Service  @relation(fields: [id_service], references: [id_service])

  @@id([id_product, id_service])
  @@index([id_service])
  @@map("stock")
}

model LigneCommande {
  id_product  Int
  id_commande Int
  quantite    Int
  price       Decimal  @db.Decimal(15, 2) 

  created_at DateTime? @default(now()) @db.DateTime(0)
  updated_at DateTime? @updatedAt @db.DateTime(0)

  product  Product  @relation(fields: [id_product], references: [id_product])
  commande Commande @relation(fields: [id_commande], references: [id_commande])

  @@id([id_product, id_commande]) 
  @@index([id_commande])
  @@map("ligne_commande")
}

// ============== QR CODE ==============

enum QRCodeStatus {
    PENDING
    SCANNED
    USED
}

model QRSession {
  id              String    @id @default(uuid())
  token           String    @unique @db.VarChar(255)
  status          QRCodeStatus @default(PENDING)
  
  // Données JSON flexibles (ex: {userId, items, orderId})
  data            Json?
  
  // Utilisateur qui a généré le QR (optionnel si généré par système)
  created_by_id   Int?
  created_by      User?     @relation("QRCreator", fields: [created_by_id], references: [id_user])
  
  // Utilisateur qui a scanné (optionnel car scan sans auth possible)
  scanned_by_id   Int?
  scanned_by      User?     @relation("QRScanner", fields: [scanned_by_id], references: [id_user])
  
  created_at      DateTime  @default(now()) @db.DateTime(0)
  scanned_at      DateTime? @db.DateTime(0)

  @@index([token])
  @@index([created_by_id])
  @@map("qr_sessions")
}
